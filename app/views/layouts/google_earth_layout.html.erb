<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  
  <head>
    <title><%= @title %></title>
    <%= yield :custom_javascript %>  	
  	<script type ="text/javascript">
  	  //Initialize global variables and load the API
      var ge;
      var ge_string = "testing";
      google.load("earth", "1");

      //Initialize the GE instance, with callbacks
      function init() {
      	google.earth.createInstance('earth', initCB, failureCB);
      }

      //Callback for succesful initialization
      function initCB(instance) {
      	ge = instance;
      	ge.getWindow().setVisibility(true);
      	ge.getSun().setVisibility(true);
      	ge.getOptions().setAtmosphereVisibility(true);
      	ge.getNavigationControl().setVisibility(ge.VISIBILITY_AUTO);
      	alert(ge_string);
      	retrieveKml();
      }

      //Callback for failed initialization
      function failureCB(errorCode) {
      }
      
      //Retrieve the KML file for the user
      function retrieveKml() {
        var href = 'http://localhost:3000/user/get_kml/'+ <%= @user.id %>;
      	google.earth.fetchKml(ge, href, kmlDidFinishLoading);
      }
      
      function kmlDidFinishLoading(kmlObject) {
        if (kmlObject) {
          alert("Retrieved KML");
          ge.getFeatures().appendChild(kmlObject);
          //ge.getTourPlayer().setTour(kmlObject);
          //ge.getTourPlayer().play();
        }
        else {
          alert("Failed to retrieve KML")
        }
      }

      //When the page has completely loaded, begin initialization
      google.setOnLoadCallback(init);
      window.onunload = GUnload;
  	</script>
  	
  	<%= javascript_include_tag :defaults %>
  	<%= javascript_include_tag "find_felix" %>
    <%= stylesheet_link_tag "earth-main" %>
  </head>
  
  <body>
    <div id="whole_page">
      <div id="header">KarunaSea</div>
      
      <div id="nav">
        <span style="float: right">
          <% if logged_in? %>
            <%= nav_link "Hub",       "user", "index" %> | 
            <%= nav_link "Logout",    "user", "logout" %>
          <% else -%>
            <%= nav_link "Sign Up!",  "user", "signup" %> | 
            <%= nav_link "Login",     "user", "login" %>
          <% end -%>
        </span>
        <%= nav_link "Home",      "site" %> |
        <%= nav_link "About",     "site", "about" %> |
        <%= nav_link "Help",      "site", "help" %> |
      </div>
      
      <div id="content">
        <% if flash[:notice] -%>
          <div id="notice"><%= flash[:notice] %></div>
        <% end -%>
        <%= @content_for_layout %>
      </div>
      
    <% if ENV["RAILS_ENV"] == "development" %>
      <div id="debug">
        <a href="#" onclick="Element.toggle('params_debug_info');return false">Params</a> | 
        <a href="#" onclick="Element.toggle('session_debug_info');return false">Session</a> | 
        <a href="#" onclick="Element.toggle('env_debug_info');return false">Env</a> | 
        <a href="#" onclick="Element.toggle('request_debug_info');return false">Request</a>
        <fieldset id="params_debug_info" class="debug_info" style="display:none">
          <legend>Params</legend>
          <%= debug(params) %>
        </fieldset>
        <fieldset id="session_debug_info" class="debug_info" style="display:none">
          <legend>Session</legend>
          <%= debug(session) %>
        </fieldset>
        <fieldset id="env_debug_info" class="debug_info" style="display:none">
          <legend>Env</legend>
          <%= debug(request.env) %>
        </fieldset>
        <fieldset id="request_debug_info" class="debug_info" style="display:none">
          <legend>Request</legend>
          <%= debug(request) %>
        </fieldset>
      </div>
    <% end %>
    </div>
  </body>
</html>